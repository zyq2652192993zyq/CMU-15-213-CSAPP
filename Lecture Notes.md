> # Lecture Notes

Course Schedule: <http://www.cs.cmu.edu/afs/cs/academic/class/15213-f15/www/schedule.html>

Labs Link: <http://csapp.cs.cmu.edu/3e/labs.html>

Reference: <https://www.jianshu.com/nb/35143394>

[TOC]

# Lecture 01: Overviews



# Lecture 02: Bits, Bytes and Ints-Part1



# Lecture 03: Bits, Bytes and Ints-Part2



# Lecture 04: Floating Point







# Lecture 11: The Memory Hierarchy

> 做Cache Lab在学完Lecture 11和12就可以开始了，开始前可以通过Recitation 6: C Review、C Boot Camp和Recitation 7: Cache Lab and Blocking来复习C语言和了解实验的要求

随机访问存储器（Random-Access Memory, RAM）分为两类：

* 静态随机访问存储器：SRAM，一般用作高速缓存存储器，价格较贵
* 动态随机访问存储器：DRAM，一般用作主存，价格为SRAM的千分之一，相对访问时间是SRAM的十倍

DRAM和SRAM一旦不通电，存储的信息就会丢失，称之为易失的（volatile）。反之，非易失性存储器（Nonvolatile Memory）即使在关电后，仍然保存着它们的信息。

如果想让数据持久化，那么就需要ROM，PROM，EPROM和闪存等。由于历史原因，ROM类型中有的类型既可以读也可以写，但是整体上都称为ROM（Read-Only Memory），根据能够被重写的次数和机制来区分的。

* PROM（Programmable ROM）：可编程ROM，只能被编程一次
* EPROM（Erasable Programmable ROM）：可擦写可编程ROM，被擦除和重编程的次数可达到1000次。
* EEPROM（Electrically Erasable Programmable ROM）：电子可擦除PROM，被编程次数达到$10^5$量记。
* Flash Memory：闪存，基于EEPROM，固态硬盘就是基于闪存的磁盘驱动器。

存储在ROM设备中的程序通常被称为固件（firmware），计算机通电后运行在ROM中的固件。

数据流通过称为总线（bus）的共享电子电路在处理器（CPU）和DRAM主存之间来来回回，每次CPU和主存之间的数据传送都是通过一系列步骤完成的，这些步骤称为总线事务（bus transaction）。

* 读事务（read transaction）：从主存传数据到CPU
* 写事务（write transaction）：从CPU传数据到主存

主要部件是CPU芯片、I/O桥接器（I/O bridge）的芯片组（其中包括内存控制器），以及组成主存的DRAM内存模块。这些部件由一对总线连接起来，其中一条总线是系统总线（system bus），它连接CPU和I/O桥接器，另一条总线是内存总线（memory bus），它连接I/O桥接器和主存。I/O桥接器将系统总线的电子信号翻译成内存总线的电子信号。I/O桥也将系统总线和内存总线连接到I/O总线，像磁盘和图形卡这样的I/O设备共享I/O总线。

![img](https://upload-images.jianshu.io/upload_images/10803273-aaa52fb85ee35ea2.jpg?imageMogr2/auto-orient/strip|imageView2/2/w/700/format/webp)

==这里是读事务和写事务的部分，书上写的很清楚==

磁盘是广为应用的保存大量数据的存储设备，存储数据的数量级可以达到几百到几千千兆字节，而基于RAM的存储器只能有几百或几千兆字节。不过，从磁盘上读信息的时间为毫秒级，比从DRAM读慢了10万倍，比从SRAM读慢了100万倍。

**传统机械硬盘**

![img](F:\Project\CMU-15-213-CSAPP\assets\10803273-ef530561bcc39d89.jpg)

磁盘是由盘片（platter）构成的。每个盘片有两面，称为表面（surface），表面覆盖着磁性记录材料。盘片中央有一个可以旋转的主轴（spindle），它使得盘片以固定的旋转速率（rotational rate）旋转，通常是5400~15000转每分钟（Revolution Per Minute，RPM）。磁盘通常包含一个或多个这样的盘片，并封装在一个密封的容器内。
每个表面是由一组称为磁道（track）的同心圆组成的。每个磁道被划分为一组扇区（sector）。每个扇区包含相等数量的数据位（通常是512字节），这些数据编码在扇区上的磁性材料中。扇区之间由一些间隙（gap）分隔开，这些间隙中不存储数据位。间隙存储用来标识扇区的格式化位。

![1584027850040](F:\Project\CMU-15-213-CSAPP\assets\1584027850040.png)

![img](https://upload-images.jianshu.io/upload_images/10803273-400ccc580e2f483d.jpg?imageMogr2/auto-orient/strip|imageView2/2/w/700/format/webp)

磁盘是由一个或多个叠放在一起的盘片组成的，它们被封装在一个密封的包装里。整个装置通常被称为磁盘驱动器（disk drive），我们通常简称为磁盘（disk）。有时，我们会称磁盘为旋转磁盘（rotating disk），以使之区别于基于闪存的固态硬盘（SSD），SSD是没有移动部分的。

磁盘制造商通常用术语柱面（cylinder）来描述多个盘片驱动器的构造，这里，柱面是所有盘片表面上到主轴中心的距离相等的磁道的集合。例如，如果一个驱动器有三个盘片和六个面，每个表面上的磁道的编号都是一致的，那么柱面k就是6个磁道k的集合。

![1584028048343](F:\Project\CMU-15-213-CSAPP\assets\1584028048343.png)

**磁盘容量**

一个磁盘上可以记录的最大位数称为它的最大容量，或者简称为容量。磁盘容量是由以下技术因素决定的：

* 记录密度（recording density）（位/英寸）：磁道一英寸的段中可以放入的位数
* 磁道密度（track density）（道/英寸）：从盘片中心出发半径上一英寸的段内可以有的磁道数。
* 面密度（areal density）（位/平方英寸）：记录密度与磁道密度的乘积。

磁盘制造商不懈地努力以提高**面密度**（从而增加容量），而**面密度**每隔几年就会翻倍。最初的磁盘，是在面密度很低的时代设计的，将每个磁道分为数目相同的扇区，扇区的数目是由最靠内的磁道能记录的扇区数决定的。为了保持每个磁道有固定的扇区数，越往外的磁道扇区隔得越开。在面密度相对比较低的时候，这种方法还算合理。不过，随着面密度的提高，扇区之间的间隙（那里没有存储数据位）变得不可接受地大。因此，现代大容量磁盘使用一种称为多区记录（multiple zone recording）的技术，在这种技术中，柱面的集合被分割成不相交的子集合，称为记录区（recording zone）。每个区包含一组连续的柱面。一个区中的每个柱面中的每条磁道都有相同数量的扇区，这个扇区的数量是由该区中最里面的磁道所能包含的扇区数确定的。

![1584028443478](F:\Project\CMU-15-213-CSAPP\assets\1584028443478.png)

![1584028522913](F:\Project\CMU-15-213-CSAPP\assets\1584028522913.png)

假设我们现在已经从蓝色区域读取完了数据，接下来需要从红色区域读，首先需要寻址，把读取的指针放到红色区域所在的磁道，然后等待磁盘旋转，旋转到红色区域之后，才可以开始真正的数据传输过程。

![img](F:\Project\CMU-15-213-CSAPP\assets\10803273-fda5756249fc9db3.jpg)

**固态硬盘(Solid State Disks(SSDs))**

![img](https://upload-images.jianshu.io/upload_images/10803273-b96d9b849faf29c3.jpg?imageMogr2/auto-orient/strip|imageView2/2/w/700/format/webp)

固态硬盘中分成很多的块(Block)，每个块又有很多页(Page)，大约 32-128 个，每个页可以存放一定数据（大概 4-512KB），页是进行数据读写的最小单位。但是有一点需要注意，对一个页进行写入操作的时候，需要先把整个块清空（设计限制），而一个块大概在 100,000 次写入之后就会报废。

与传统的机械硬盘相比，固态硬盘在读写速度上有很大的优势。但是因为设计本身的约束，连续访问会比随机访问快，而且如果需要写入 Page，那么需要移动其他 Page，擦除整个 Block，然后才能写入。现在固态硬盘的读写速度差距已经没有以前那么大了，但是仍然有一些差距。

不过与机械硬盘相比，固态硬盘存在一个具体的寿命限制，价格也比较贵，但是因为速度上的优势，越来越多设备开始使用固态硬盘。

**总线**

总线是用来传输地址、数据和控制信号的一组平行的电线，通常来说由多个设备共享，类似于不同城市之间的高速公路，可以传输各类数据。CPU 通过总线和对应的接口来从不同的设备中获得所需要的数据，放入寄存器中等待运算，像下面这样：

![img](F:\Project\CMU-15-213-CSAPP\assets\10803273-aaa52fb85ee35ea2-1584370848611.jpg)

假设 CPU 需要从硬盘中读取一些数据，会给定指令，逻辑块编号和目标地址，并发送给磁盘控制器。然后磁盘控制器会读取对应的数据，并通过 DMA(direct memory access)把数据传输到内存中；传输完成后，磁盘控制器通过中断的方式通知 CPU，然后 CPU 完成之后的工作。

总线上连接的各个设备，其访问速度有天壤之别，不同的技术发展速度不同，更加剧了这个情况

**局部性**

一个编写良好的计算机程序常常具有良好的**局部性（locality）**。也就是，它们倾向于引用邻近于其他最近引用过的数据项的数据项，或者最近引用过的数据项本身。这种倾向性，被称为局部性原理（principle of locality），是一个持久的概念，对硬件和软件系统的设计和性能都有着极大的影响。

* 时间局部性（temporal locality）：在一个具有良好时间局部性的程序中，被引用过一次的内存位置很可能在不远的将来再被多次引用。
* 空间局部性（spatial locality）：在一个具有良好空间局部性的程序中，如果一个内存位置被引用了一次，那么程序很可能在不远的将来引用附近的一个内存位置。

**局部性小结**

* 重复引用相同变量的程序有良好的时间局部性。
* 对于具有步长为k的引用模式的程序，步长越小，空间局部性越好。具有步长为l的引用模式的程序有很好的空间局部性。在内存中以大步长跳来跳去的程序空间局部性会很差。
* 对于取指令来说，循环有好的时间和空间局部性。循环体越小，循环迭代次数越多，局部性越好。

**存储体系 Memory Hierarchy**

一种介质的速度越快就会越贵，同时也消耗更多的电量，所以一般容量比较小。而 CPU 和内存之间的速度差距越来越大，所以好的程序都会尽可能利用局部性。而根据这些特性，引申出了安排存储的方式，称为金字塔式存储体系(Memory Hierarch)。

![1584371535496](F:\Project\CMU-15-213-CSAPP\assets\1584371535496.png)

存储器层次结构的中心思想是，对于每个k，位于k层的更快更小的存储设备作为位于k+1层的更大更慢的存储设备的缓存。换句话说，层次结构中的每一层都缓存来自较低一层的数据对象。

![1584371753764](F:\Project\CMU-15-213-CSAPP\assets\1584371753764.png)

类似地，第k层的存储器被划分成较少的块的集合，每个块的大小与k+1层的块的大小一样。在任何时刻，第k层的缓存包含第k+1层块的一个子集的副本。

**1. 缓存命中**

当程序需要第k+1层的某个数据对象d时，它首先在当前存储在第k层的一个块中查找d。如果d刚好缓存在第k层中，那么就是我们所说的缓存命中（cache hit）。该程序直接从第k层读取d，根据存储器层次结构的性质，这要比从第k+1层读取d更快。例如，一个有良好时间局部性的程序可以从块14中读出一个数据对象，得到一个对第k层的缓存命中。

**2. 缓存未命中**

另一方面，如果第k层中没有缓存数据对象d，那么就是我们所说的缓存不命中（cache miss）。当发生缓存不命中时，第k层的缓存从第k+1层缓存中取出包含d的那个块，如果第k层的缓存已经满了，可能就会覆盖现存的一个块。
覆盖一个现存的块的过程称为替换（replacing）或驱逐（evicting）这个块。被驱逐的这个块有时也称为牺牲块（victim block）。决定该替换哪个块是由缓存的替换策略（replacement policy）来控制的。例如，一个具有随机替换策略的缓存会随机选择一个牺牲块。一个具有最近最少被使用（LRU）替换策略的缓存会选择那个最后被访问的时间距现在最远的块。

